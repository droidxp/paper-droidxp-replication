---
title: "Dataset Merge"
author: "anonymous"
date: '2022-10-14'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=5, fig.height=5, fig.path='./figures/', dev=c('png', 'pdf'))

setwd(".")

library(sqldf)
library(xtable)
```

## Merge Script

The purpose of this R script is to merge several datasets into a single one. 
The following datasets are merged:

   * *appsHash* contains the hash of all apps, including information to indicate 
   if a given asset is an original or a repackaged version of an app. 
   
   * *avclass* contains the results of using the tool av2class to identify 
   the family of the malware in our dataset. 
   
   * *originalMalwareSample* contains the hash of the apps used in the 
   Bao et al. study. 
   
   * *summaryTypeFamily.csv* contains the outputs of the mining android sandbox 
   approach. 
   
We merge the above datasets and export the results to a file named *final-ds.csv*.   


```{r vt}
apps <- read.csv("appsHash.csv", head=T, sep=',')

repackaged <- sqldf("select * from apps where version = 'malicious'")

nrow(repackaged)

avclass <- read.csv("avclass.csv", head=T, sep=',')

nrow(avclass)

avclass <- sqldf("select * 
                  from avclass 
                  where family != 'undetected' and family not like 'SINGLETON%'")

nrow(avclass)
write.csv(avclass, "av.csv", quote = F, row.names = F)

#hashes <- read.csv("sha256-md5-app.csv",head=T, sep=',')


#nrow(hashes)


s1 <- sqldf("select r.app, r.hash, a.family, 'True' as Malware
				from repackaged r, avclass a where r.hash = upper(a.hash)")
						 

s2 <- sqldf("select r.app, r.hash, 'None' as family, 'False' as Malware
                   from repackaged r
                   where r.hash not in (select upper(a.hash) from avclass a)")

nrow(s1)

nrow(s2)

ds <- rbind(s1, s2)

# masResults <- read.csv("summaryTypeFamily.csv", head=T)

# malwares <- sqldf("select m1.*, m2.malware as callDifferentAPIs, m2.hasDifferentTraces 
#                   from malwares m1, masResults m2 where m1.app = m2.app")

#nrow(malwares)
#colnames(malwares)

original <- read.csv("originalMalwareSample.csv", head=T)

s1 <- sqldf("select ds.*, 'True' PreviousStudy 
             from ds where 
             ds.app in (select app from original)")

s2 <- sqldf("select ds.*, 'False' PreviousStudy 
             from ds where 
             ds.app not in (select app from original)")

nrow(s1)
nrow(s2)

ds <- rbind(s1,s2)

masResults <- read.csv("summaryTypeFamily.csv", head=T)

final_ds <- sqldf("select ds.*, m.malware as APIDetected, m.hasDifferentTraces as TraceDetected 
                   from ds, masResults m where ds.app = m.app")

colnames(final_ds)
head(final_ds)


 write.csv(final_ds, "final-ds.csv",  quote = F, row.names = F)
```




