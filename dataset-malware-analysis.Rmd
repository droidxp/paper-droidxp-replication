---
title: "dataset-malware-analysis"
author: "anonymous"
date: '2022-10-14'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=5, fig.height=5, fig.path='./figures/', dev=c('png', 'pdf'))

setwd(".")

library(sqldf)
library(xtable)
```


```{r load, echo=FALSE}
original <- read.csv("originalMalwareSample.csv", head=T)

colnames(original)
nrow(original)

malwares <- read.csv("summaryTypeFamily.csv", head=T)

colnames(malwares)
nrow(malwares)

sqldf("select type, count(*) from malwares group by type")
sqldf("select family, count(*) from malwares group by family")


sqldf("select type, count(*) from malwares m, original o where m.app = o.app group by type")
sqldf("select family, count(*) from malwares  m, original o where m.app = o.app group by family")
```


```{r accuracy}
## [1] "app"                                "type"                              
## [3] "family"                             "maliciouApp_methodsSensitiveAccess"
## [5] "malwareDetected"                    "hasDifferentTraces"


sqldf("select malwareDetected, count(*) 
       from malwares m
       group by malwareDetected")

sqldf("select hasDifferentTraces, count(*) 
       from malwares m 
       where malwareDetected = 'False'
       group by hasDifferentTraces")



sqldf("select malwareDetected, count(*) 
       from malwares m, original o 
       where m.app = o.app 
       group by malwareDetected")

sqldf("select hasDifferentTraces, count(*) 
       from malwares m, original o 
       where m.app = o.app and malwareDetected = 'False'
       group by hasDifferentTraces")

```

### Similarity Assessment

```{r similarity}

similarity <- read.csv("summarySimiDroid.csv", head=T, sep=",")

s1 <- sqldf("select s.*, 'Complete Dataset' as dataset
                             from similarity s
                             where s.app not in (select app from original)")

s2 <- sqldf("select s.*, 'Small Dataset' as dataset
                             from similarity s
                             where s.app in (select app from original)")



summary(s1$simiScore)
sd(s1$simiScore)

summary(s2$simiScore)
sd(s2$simiScore)

similarity = rbind(s1, s2)

sqldf("select dataset, count(*) from similarity")

similarity$dataset <- factor(similarity$dataset , levels=c("Small Dataset", "Complete Dataset"))


boxplot(simiScore~dataset, data = similarity, xlab="Dataset", ylab="Similarity Score")

similarity <- sqldf("select m.*, s.* from malwares m, similarity s where m.app = s.app")

nrow(similarity)

similarity["Kill"] <- ifelse(similarity$malwareDetected == "True", 1, 0)

sqldf("select Kill, count(*) from similarity group by Kill")
model <- glm(Kill~simiScore, data=similarity, family = "binomial")

summary(model)

cor.test(similarity$Kill,similarity$simiScore,method="spearman")


# https://www.datanovia.com/en/lessons/k-means-clustering-in-r-algorith-and-practical-examples/#:~:text=K%2Dmeans%20clustering%20can%20be,number%20of%20cluster%20to%20generate.
set.seed(123)

km.res <- kmeans(similarity$simiScore, 5)

print(km.res)

dd <- cbind(similarity, cluster = km.res$cluster)

head(dd)

s1 <- sqldf("select cluster, count(*) as total from dd group by cluster")
s2 <- sqldf("select cluster, count(*) as totalKilled from dd where malwareDetected = 'True' group by cluster")

dd = merge(s1, s2)

dd["Percent"] = dd$totalKilled * 100 / dd$total


# 129, 190, 181, 448, 256
## 
## Cluster means:
##         [,1]
## 1 0.27402598
## 2 0.07206597
## 3 0.51337268
## 4 0.94180143
## 5 0.74342319

cs = data.frame("cluster" = c(1,2,3,4,5), 
                "averageSimilarity" = c(0.27, 0.07, 0.51, 0.94, 0.74))

xtable(merge(dd, cs))

```

