---
title: "dataset-malware-analysis"
author: "Rodrigo Bonif√°cio et al."
date: '2022-10-14'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=5, fig.height=5, fig.path='./figures/', dev=c('png', 'pdf'))

setwd(".")

library(sqldf)
library(xtable)
```




```{r vt}
final_ds <- read.csv("final-ds.csv", head=T, sep=',')

nrow(final_ds)
colnames(final_ds)

## [1] "app"           "sha256"        "family"        "Malware"      
## [5] "PreviousStudy" "APIDetected"   "TraceDetected"

sqldf("select Malware, count(*) from final_ds group by Malware")

sqldf("select PreviousStudy, count(*) from final_ds group by PreviousStudy")

sqldf("select APIDetected, count(*) from final_ds group by APIDetected")

sqldf("select Malware, PreviousStudy, APIDetected,  count(*) 
       from final_ds group by  Malware, PreviousStudy, APIDetected")


##   Malware count(*)
## 1   False      908
## 2    True      296

##   PreviousStudy count(*)
## 1         False     1103
## 2          True      101

##   APIDetected count(*)
## 1       False      863
## 2        True      341


##   Malware PreviousStudy APIDetected count(*)
## 1   False         False       False      619
## 2   False         False        True      217
## 3   False          True       False       33
## 4   False          True        True       39
## 5    True         False       False      207
## 6    True         False        True       60
## 7    True          True       False        4
## 8    True          True        True       25


##   Malware PreviousStudy APIDetected count(*)
## 1   False         False       False      559
## 2   False         False        True      174
## 3   False          True       False       31
## 4   False          True        True       17
## 5    True         False       False      267
## 6    True         False        True      103
## 7    True          True       False        6
## 8    True          True        True       47




sqldf("select family, count(*) 
       from final_ds where PreviousStudy = 'True'
       group by family")


sqldf("select family, count(*) 
       from final_ds 
       group by family")


sqldf("select PreviousStudy, Malware, count(*) 
       from final_ds  
       -- where Malware = 'True'
       group by PreviousStudy, Malware")

```

```{r accuracy-ps}

tp <- sqldf("select count(*) as TP
             from final_ds 
             where PreviousStudy = 'True' and 
                   Malware = 'True' and 
                   APIDetected = 'True'")
fp <- sqldf("select count(*) as FP
             from final_ds 
             where PreviousStudy = 'True' and 
                   Malware = 'False' and 
                   APIDetected = 'True'")

fn <- sqldf("select count(*) as FN
             from final_ds 
             where PreviousStudy = 'True' and 
                   Malware = 'True' and 
                   APIDetected = 'False'")


tn <- sqldf("select count(*) as TN
             from final_ds 
             where PreviousStudy = 'True' and 
                   Malware = 'False' and 
                   APIDetected = 'False'")

tp 
fp
fn
tn

precision = tp / (tp + fp)

recall = tp / (tp + fn)

precision
recall

Fmeasure = 2 * (precision*recall) / (precision + recall)

Fmeasure


tp <- sqldf("select count(*) as TP
             from final_ds 
             where PreviousStudy = 'True' and 
                   Malware = 'True' and 
                   (APIDetected = 'True' or TraceDetected = 'True')")

fp <- sqldf("select count(*) as FP
             from final_ds 
             where PreviousStudy = 'True' and 
                   Malware = 'False' and 
                   (APIDetected = 'True' or TraceDetected = 'True')")

fn <- sqldf("select count(*) as FN
             from final_ds 
             where PreviousStudy = 'True' and 
                   Malware = 'True' and 
                   (APIDetected = 'False' and TraceDetected = 'False')")


tn <- sqldf("select count(*) as TN
             from final_ds 
             where PreviousStudy = 'True' and 
                   Malware = 'False' and 
                   (APIDetected = 'False' and TraceDetected = 'False')")

tp 
fp
fn
tn

precision = tp / (tp + fp)

recall = tp / (tp + fn)

precision
recall

Fmeasure = 2 * (precision*recall) / (precision + recall)

Fmeasure
```




```{r accuracy-complete}

tp <- sqldf("select count(*) as TP
             from final_ds 
             where Malware = 'True' and 
                   APIDetected = 'True'")

fp <- sqldf("select count(*) as FP
             from final_ds 
             where Malware = 'False' and 
                   APIDetected = 'True'")

fn <- sqldf("select count(*) as FN
             from final_ds 
             where Malware = 'True' and 
                   APIDetected = 'False'")


tn <- sqldf("select count(*) as TN
             from final_ds 
             where Malware = 'False' and 
                   APIDetected = 'False'")

tp 
fp
fn
tn

precision = tp / (tp + fp)

recall = tp / (tp + fn)

precision
recall

Fmeasure = 2 * (precision*recall) / (precision + recall)

Fmeasure


tp <- sqldf("select count(*) as TP
             from final_ds 
             where Malware = 'True' and 
                   (APIDetected = 'True' or TraceDetected = 'True') ")

fp <- sqldf("select count(*) as FP
             from final_ds 
             where Malware = 'False' and 
                  (APIDetected = 'True'  or TraceDetected = 'True')")

fn <- sqldf("select count(*) as FN
             from final_ds 
             where Malware = 'True' and 
                   (APIDetected = 'False' and TraceDetected = 'False')")


tn <- sqldf("select count(*) as TN
             from final_ds 
             where Malware = 'False' and 
                    (APIDetected = 'False' and TraceDetected = 'False')")


tp 
fp
fn
tn

precision = tp / (tp + fp)

recall = tp / (tp + fn)

precision
recall

Fmeasure = 2 * (precision*recall) / (precision + recall)

Fmeasure
```




### Similarity Assessment

```{r similarity, eval=TRUE}

similarity <- read.csv("summarySimiDroid.csv", head=T, sep=",")

similarity <- sqldf("select d.*, s.simiScore
                     from final_ds d, similarity s 
                     where d.app = s.app")

s1 <- sqldf("select s.*, 'Small Dataset' as dataset
                             from similarity s
                             where PreviousStudy = 'True'")

s2 <- sqldf("select s.*, 'Complete Dataset' as dataset
                             from similarity s
                             where PreviousStudy = 'False'")



summary(s1$simiScore)
sd(s1$simiScore)

summary(s2$simiScore)
sd(s2$simiScore)


similarity = rbind(s1, s2)

summary(similarity$simiScore)
sd(similarity$simiScore)

sqldf("select dataset, count(*) from similarity")

sqldf("select count(*) from similarity where simiScore < 0.25")
sqldf("select count(*)  from similarity where simiScore >= 0.25 and simiScore < 0.5")
sqldf("select count(*)  from similarity where simiScore >= 0.5 and simiScore < 0.75")
sqldf("select count(*)  from similarity where simiScore >= 0.75")



similarity$dataset <- factor(similarity$dataset , levels=c("Small Dataset", "Complete Dataset"))


boxplot(simiScore~dataset, data = similarity, xlab="Datasets", ylab="Similarity Score")

```

```{r eval=TRUE}

s1 <- sqldf("select app, family, 1 as h1 
             from final_ds 
             where (Malware = 'True' and (APIDetected = 'True' or TraceDetected = 'True')) or 
                   (Malware = 'False' and APIDetected = 'False' and TraceDetected = 'False')")

s2 <- sqldf("select app, family, 0 as h1 
             from final_ds 
             where (Malware = 'True' and APIDetected = 'False' and TraceDetected = 'False') or 
                   (Malware = 'False' and (APIDetected = 'True' or TraceDetected = 'True'))")

ds <- rbind(s1, s2)


ds$h1 <- as.factor(ds$h1)

similarity <- sqldf("select s.*, ds.h1
                     from ds, similarity s 
                     where ds.app = s.app")

nrow(similarity)

sqldf("select h1, count(*) from similarity group by h1")

model <- glm(h1~simiScore, data=similarity, family = "binomial")

summary(model)

# cor.test(similarity$h1,similarity$simiScore,method="spearman")


# https://www.datanovia.com/en/lessons/k-means-clustering-in-r-algorith-and-practical-examples/#:~:text=K%2Dmeans%20clustering%20can%20be,number%20of%20cluster%20to%20generate.

set.seed(123)

km.res <- kmeans(similarity$simiScore, 5)

print(km.res)

dd <- cbind(similarity, cluster = km.res$cluster)

head(dd)

s1 <- sqldf("select cluster, count(*) as total from dd group by cluster")
s2 <- sqldf("select cluster, count(*) as hits from dd where h1 = 1 group by cluster")

dd = merge(s1, s2)

dd["Percent"] = dd$hits * 100 / dd$total


## 1 0.94546089
## 2 0.54306770
## 3 0.76053535
## 4 0.29863716
## 5 0.07534689
#

cs = data.frame("cluster" = c(1,2,3,4,5,6,7,8,9,10), 
                "averageSimilarity" = c(0.94, 0.54, 0.76, 0.29, 0.75))

xtable(merge(dd, cs))

```

### Family

```{r gappusin}
ds <- sqldf("select * from similarity where family != 'None'")
colnames(ds)
nrow(ds)

sqldf("select h1, count(*) from ds group by h1")

sqldf("select family, h1, count(*) 
       from ds 
       group by family, h1 
       order by 3 desc")

sqldf("select family, count(*) 
       from ds group by family 
       order by 2 desc")


sqldf("select family, count(*) 
       from ds 
       where PreviousStudy = 'True' 
       group by family 
       order by 2 desc")

sqldf("select count(*) 
       from ds 
       where PreviousStudy = 'True' ")

tab <- sqldf("select malware, apidetected, tracedetected, count(*) 
       from ds 
       where family = 'gappusin' 
       group by malware, apidetected, tracedetected")

xtable(tab)


tp <- sqldf("select count(*) as TP
             from final_ds 
             where Malware = 'True' and family != 'gappusin' and
                   (APIDetected = 'True' or TraceDetected = 'True') ")

fp <- sqldf("select count(*) as FP
             from final_ds 
             where Malware = 'False' and family != 'gappusin' and
                  (APIDetected = 'True'  or TraceDetected = 'True')")

fn <- sqldf("select count(*) as FN
             from final_ds 
             where Malware = 'True' and family != 'gappusin' and
                   (APIDetected = 'False' and TraceDetected = 'False')")


tn <- sqldf("select count(*) as TN
             from final_ds 
             where Malware = 'False' and family != 'gappusin' and
                    (APIDetected = 'False' and TraceDetected = 'False')")

precision <- tp / (tp + fp)
recall <- tp / (tp + fn)

Fmeasure <- 2 *(precision*recall)/(precision+recall)

precision
recall
Fmeasure

#ds$h1 <- as.factor(ds$h1)


ds$family <- as.factor(ds$family)

similarity$family <- as.factor(similarity$family)


xtabs(~h1 + family, data=ds)

model <- glm(h1~family, data=ds, family = "binomial")
summary(model)

model <- glm(h1~family, data=similarity, family = "binomial")
summary(model)


model <- glm(h1~simiScore + family, data=similarity, family = "binomial")
summary(model)


model <- glm(h1~simiScore + family + family:simiScore, data=similarity, family = "binomial")
summary(model)


gps <- sqldf("select * from similarity where family = 'gappusin'")

summary(gps$simiScore)
sd(gps$simiScore)

hist(gps$simiScore, main="", xlab="Similarity Score", ylab="Frequency")


```


# Gappusin

```{r}
g_ds <- read.csv("gappusin-analysis-summary.csv", head=T, sep=',')

g_ds <- sqldf("select substr(hash, 1, 7) Hash, SimiScore, Identical, Similar, New, Deleted 
       from g_ds")

#xtable(g_ds)
print(xtable(g_ds), include.rownames=FALSE)

median(g_ds$SimiScore)
median(g_ds$Similar)
median(g_ds$New)
median(g_ds$Deleted)

g_ds <- read.csv("gappusin-analysis.csv", head=T, sep=',')
colnames(g_ds)


sqldf("select observation, substr(method, 1, 60) method, count(*) 
       from g_ds 
       group by observation, method 
       order by 3 desc")

```
